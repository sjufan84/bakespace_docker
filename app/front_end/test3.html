<!DOCTYPE html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" type = "text/css" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <title id="title">BakeBot</title>
    <style>

      .recipe-container {
          overflow-y: auto; /* Adds a scrollbar when content overflows */
      }

      .output-container {
          overflow-y: auto; /* Adds a scrollbar when content overflows */
      }
      .small-image {
      width: 30px; /* Adjust this value to your liking */
      height: 30px; /* Adjust this value to your liking */
    }
  </style>
  
</head>
  <body>
    <!--<div id="fullPage" class="grid grid-cols-2 grid-rows-2 flex-auto"> -->
    <div id="mainContainer" class="grid grid-cols-12 grid-rows-12 flex-auto">
      <div class="row col-md-12">
        <!-- Recipe Display Column -->
        <div class="col-md-8 flex-auto">
          <div class="flex-auto recipe-container bg-light shadow rounded p-4 max-h-3/4">
            <h2 class="h3 font-weight-bold mb-3" id="recipeName">Your Recipe:</h2>
            <div id="recipeContent" class="recipe-content"></div>
          </div>
        </div>
    
        <!-- Chat Column -->
        <div class="col-md-4 flex-auto" id="chatColumn">
          <!-- Chat container row -->
          <div class="row-span-2 col-md-12 ">
            <div id="chatBox" class="card p-3 bg-light shadow rounded overflow-auto flex-auto row-span-2">
              <div id="chat-messages" class="flex-auto overflow-y-auto">
                <!-- BakeBot message -->
                <div class="bot-message mb-2 d-flex justify-content-start align-items-center mr-2" id="bot-message">
                  <img src="../../resources/bakebot_icon.png" alt="BakeBot" class="chat-icon small-image">
                  <div class="chat-bubble bot-bubble ml-2 bg-red-200">This looks great!  Let me know if you have any questions, want to generate a pairing, or anything else I can help with!
                  </div>
                </div>
                <!-- User message -->
                <div class="user-message mb-2 d-flex justify-content-end align-items-center" id="user-message">
                  <img src="../../resources/user_image.png" alt="User" class="chat-icon small-image ml-2">
                  <div class="chat-bubble user-bubble mr-3 text-end">I hate you!</div>
                </div>
              </div>
              <!-- User input area -->
              <div class="input-area" id="chatInputArea">
                <div class="row mb-2 p-2 align-bottom">
                  <textarea class="form-control" placeholder="Type your message..." id="chatInput"></textarea>
                </div>
                <div class="row col-md-12 justify-content-around mb-3">
                  <select class="col-md-6" id="chefStyle">
                  <option>Classic Pro Chef</option>
                  <option>Sweet Home Chef</option>
                  <option>Snarky Fun Chef</option>
                  </select>
                  <button class="btn btn-secondary col-md-5" id="sendChat">Send</button>
                </div>
                <div class="col-md-12 justify-content-around">
                  <p class="p-2 col-md-12 font-bold">Some examples of where we can go from here:</p>
                  <button id="generatePairings" type="promptInput" class="btn border-black col-md-5 col-md-12 mb-1">Can I get a wine pairing with this?</button>
                  <button id="generateImage" type="promptInput" class="btn border-black col-md-12 mb-1">I'd love to create an image of this recipe.</button>
                  <button id="adjustRecipe" type="promptInput" class="btn border-black col-md-12 mb-1">I'd like to adjust this recipe.</button>
                  <button id="saveRecipe" type="promptInput" class="btn border-black col-md-12">I'd like to save this recipe.</button>   
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tool Outputs Column -->
          <!-- We want to reserve two columns directly below the recipe
        container and the chat column that that will display the image and / or
        or the pairing messages.  If there is only one tool output,
        it should take up the same width and height as the recipe container.
        If there are two, they should each take up 1/2 of the width of the
        recipe container but be the same height as the recipe.  All
        overflow should be handled automatically  -->
        <div class="row col-md-12" id="toolOutputs">
        </div>
      </div>
</body>
<script>
  let threadId = null;
  let toolName = null;
  let toolOutput = null;
  let message = null;
  let recipeName = null;
  let recipeData = null;
  let uploadedRecipeData = null;
  let recipeContent = null;
  let converter = new showdown.Converter();
  let tools_list = ["create_recipe", "adjust_recipe", "generate_pairings", 
  "generate_image", "format_recipe", "initial_pass", "get_thread_tool_outputs",
  "get_specific_thread_tool_outputs"]
  let metadata = null;

  // Check to see if there is a recipeData or uploadedRecipeData in local storage
  // If there is uploadedRecipe data, display the fields as editable
  // If there is recipeData, display the recipe
  //if (localStorage.getItem('recipeData')) {
  //  let recipeData = JSON.parse(localStorage.getItem('recipeData'));
  //  let threadId = recipeData.thread_id;
    // Display the recipe
  //  loadRecipeData(recipeData);
  //}
  if (localStorage.getItem('uploadedRecipeData')) {
    // Display the editable fields
    displayAndEditRecipe(JSON.parse(localStorage.getItem('uploadedRecipeData')));
  }
    // Create a function to load in the local recipeData and then display the results in the 
  // recipeContent div's innerHTML
  function loadRecipeData(recipeData) {
    console.log('recipeData:', recipeData)
    // Set the recipeName h2 to the recipe name
    let recipe_name = JSON.parse(recipeData.tool_return_values[0].output).recipe_name;
    document.getElementById('recipeName').innerHTML = recipe_name;
    // Convert the recipe data to HTML
    let html = converter.makeHtml(recipeData.message);
    // Display the recipe data in the recipeContent div
    document.getElementById('recipeContent').innerHTML = html;
  }

  function displayAndEditRecipe(uploadedRecipe) {
  // Create the form
  let form = document.createElement('form');
  form.className = 'needs-validation';
  form.noValidate = true;
  // Overflow should be handled automatically
  form.style.overflow = 'auto';
  // Max height of the form should be 3/4 of the recipe container
  form.style.maxHeight = '75%';

  // For each property in the uploadedRecipe object
  for (let property in uploadedRecipe) {
    // Check if the property is 'ingredients' or 'directions'
    if (property === 'ingredients' || property === 'directions') {
      // Create a list group
      let listGroup = document.createElement('ul');
      listGroup.className = 'list-group mb-3'; // Add margin-bottom for space between fields

      // For each item in the property array
      for (let i = 0; i < uploadedRecipe[property].length; i++) {
        // Create a list group item
        let listItem = document.createElement('li');
        listItem.className = 'list-group-item';

        // Create an input field
        let input = document.createElement('input');
        input.id = property + i;
        input.value = uploadedRecipe[property][i];
        input.className = 'form-control';
        input.required = true;

        // Append the input field to the list group item
        listItem.appendChild(input);

        // Append the list group item to the list group
        listGroup.appendChild(listItem);
      }

      // Append the list group to the form
      form.appendChild(listGroup);
    } else {
      // Create a form group
      let formGroup = document.createElement('div');
      formGroup.className = 'form-group mb-3'; // Add margin-bottom for space between fields

      // Create a label
      let label = document.createElement('label');
      label.textContent = property.charAt(0).toUpperCase() + property.slice(1) + ':'; // Capitalize and add a colon
      label.for = property;
      label.className = 'form-label'; // Add Bootstrap class for bold text

      // Create an input field
      let input = document.createElement('input');
      input.id = property;
      input.value = uploadedRecipe[property];
      input.className = 'form-control';
      input.required = true;

      // Append the label and input field to the form group
      formGroup.appendChild(label);
      formGroup.appendChild(input);

      // Append the form group to the form
      form.appendChild(formGroup);
    }
  }

  // Create a submit button
  let submitButton = document.createElement('button');
  submitButton.type = 'submit';
  submitButton.textContent = 'Submit';
  submitButton.className = 'btn btn-primary mt-3'; // Add margin-top for space above the button

  // Append the submit button to the form
  form.appendChild(submitButton);

  // Add an event listener to the form
  form.addEventListener('submit', function(event) {
    // Prevent the default form submission
    event.preventDefault();

    // Get the new values from the input fields and update the uploadedRecipe object
    for (let property in uploadedRecipe) {
      if (property === 'ingredients' || property === 'directions') {
        for (let i = 0; i < uploadedRecipe[property].length; i++) {
          uploadedRecipe[property][i] = document.getElementById(property + i).value;
        }
      } else {
        uploadedRecipe[property] = document.getElementById(property).value;
      }
    }
    // Create a new recipe object
    let uploadedRecipe = {
      'recipe_name': uploadedRecipe.recipe_name,
      'ingredients': uploadedRecipe.ingredients,
      'directions': uploadedRecipe.directions,
      'preptime': uploadedRecipe.prep_time,
      'cooktime': uploadedRecipe.cook_time,
      'totaltime': uploadedRecipe.total_time,
      'servings': uploadedRecipe.servings,
      'calories': uploadedRecipe.calories,
    };
      // Re-submit the recipe
    // You'll need to replace this with your own function for submitting the recipe
    submitRecipe(uploadedRecipe);
  });

  // Append the form to the DOM
  // You'll need to replace 'recipeContent' with the id of the element where you want to display the form
  document.getElementById('recipeContent').appendChild(form);
}

// Create a function to submit the recipe
function submitRecipe(recipe) {}
  // @TODO - Add your code here

  function convertChefStyle(chefStyle) {
      const chefStyleMap = {
        'Classic Pro Chef': 'pro_chef',
        'Sweet Home Chef': 'home_cook',
        'Snarky Fun Chef': 'adventurous_chef'
      };
      return chefStyleMap[chefStyle] || chefStyle; // Fallback to original if not found
    }

  function displayMessage(message, sender) {
    // Display the message in the appropriate chat bubble
    if (sender === 'user') {
      // Create a new user message
      let userMessage = document.createElement('div');
      userMessage.className = 'user-message mb-2 d-flex justify-content-end align-items-center';
      userMessage.innerHTML = `
        <img src="../../resources/user_image.png" alt="User" class="chat-icon small-image ml-2">
        <div class="chat-bubble user-bubble mr-3 text-end">${message}</div>
      `;
      // Append the user message to the chat messages container
      document.getElementById('chat-messages').appendChild(userMessage);
    }
    else {
      // Create a new bot message
      let botMessage = document.createElement('div');
      botMessage.className = 'bot-message mb-2 d-flex justify-content-start align-items-center mr-2';
      botMessage.innerHTML = `
        <img src="../../resources/bakebot_icon.png" alt="BakeBot" class="chat-icon small-image">
        <div class="chat-bubble bot-bubble ml-2 bg-red-200">${message}</div>
      `;
      // Append the bot message to the chat messages container
      document.getElementById('chat-messages').appendChild(botMessage);
    }
  }
    
  // Create a listener for the generatePairings button
  document.getElementById('generatePairings').addEventListener('click', function() {
    let message = "Please generate wine pairings for a Kung Pao Chicken dish.";
    let sender = "user";
    console.log('generatePairings clicked')
    // Add a new bot message to the chat
    // Asking the user what type of pairing
    // they would like and providing a few examples i.e. wine, beer, etc.
    displayMessage(message, sender);
  });
    
  document.getElementById('sendChat').addEventListener('click', function() {
    console.log('sendChat clicked')
    // Get the chef style from the dropdown
    let chefStyle = document.getElementById('chefStyle').value;
    // Get the user input
    let userInput = document.getElementById('chatInput').value;
    console.log('userInput:', userInput)
    // Check if the user input is empty
    if (userInput.trim() !== '') {
        // Display user question
        displayMessage(userInput, 'user');

        // Send input to BakeBot API and get response
        fetchBakeBotResponse(userInput, chefStyle).then(response => {
            // Display BakeBot's response
            displayMessage(response, 'bakebot');
        });

        // Clear the input field
        document.getElementById('chatInput').value = '';
    }
});

function addToolOutputContainer(toolOutput, toolName) {
  // Get the tool outputs container
  let toolOutputsContainer = document.getElementById('toolOutputs');

  // Create a new div element for the tool output
  let toolOutputDiv = document.createElement('div');

  // Add the tool output to the div
  toolOutputDiv.innerHTML = `<h2>${toolName}</h2><pre>${toolOutput}</pre>`;

  // Append the tool output div to the tool outputs container
  toolOutputsContainer.appendChild(toolOutputDiv);
}

function displayPairingOutput(message) {
  // Get the output container element
  let outputContainer = document.getElementById('output-container');

  // Create a new div element for each tool output
  let outputDiv = document.createElement('div');

  // Decide how to display based on tool name
  switch (toolName) {
      case 'generate_pairings':
          // Display pairings as text
          outputDiv.innerHTML = `<h3>Pairings</h3><pre>${generatePairingCards(toolOutput.pairings)}</pre>`;
          break;
      case 'generate_image':
          // Display image
          // Assuming toolOutput is a URL to the image
          let imageContent = `<h3>Generated Image</h3><img src="${toolOutput}" alt="Generated Image">`;
          outputDiv.innerHTML = imageContent;
          break;
      case 'create_recipe':
          // Display recipe as HTML
          let html = converter.makeHtml(message);
          document.getElementById('recipeContent').innerHTML = html;
          console.log(html);
          break;
      
      // Handle other tool names...
      default:
          // Default text output
          //outputDiv.innerHTML = `<h2>${toolName}</h2><pre>${toolOutput}</pre>`;
          break;
  }

  // Append the output div to the output container
  outputContainer.appendChild(outputDiv);

  // Add a new container for the tool output
  addToolOutputContainer(toolOutput, toolName);
}

async function fetchBakeBotResponse(userInput, chefStyle) {
    // Convert the frontend chef style to match the backend model's expected values
    let chefType;
    if (chefStyle === "Home Cook") {
        chefType = "home_cook";
    }
    else if (chefStyle === "Pro Chef") {
        chefType = "pro_chef";
    }
    else {
        chefType = "adventurous_chef";
    }
    console.log('fetchBakeBotResponse called with userInput:', userInput, 'and chefStyle:', chefStyle, 'and threadId:', threadId)
    // If thread ID is null, create a new thread
    if (threadId === null) {
      console.log('threadId is null')
      // Send this data to FastAPI backend
      fetch('http://localhost:8000/create_thread_run', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "message_content": userInput,
              "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
              // If there is no serving size, set it to an empty string
              "serving_size": ""
          })
      }
      ).then(response => response.json())
      .then(data => {
        // Convert the JSON response to a JavaScript object
        data = JSON.parse(data);
        // Extract the message from the response
        let message = data.message
        // Store the thread ID
        threadId = data.thread_id;

        // Handle each tool's output
        let tools = data.tool_return_values;
        console.log('tools:', tools)
        tools.forEach(tool => {
            console.log('tool:', tool)
            // Convert the tool output to HMTL
            displayToolOutput(tool, message);
          });
        }).catch(error => console.error('Error:', error))
    }
    else {
      let response = await fetch('http://localhost:8000/add_message_and_run', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              "message_content": userInput,
              "chef_type": chefType,
              "thread_id": threadId
          })
      });
      // Convert the JSON response to a JavaScript object
      let data = await response.json();
      console.log('data:', data)
      data = JSON.parse(data);
      // Extract the message from the response
      let message = data.message
      // Store the thread ID
      threadId = data.thread_id;

      // Handle each tool's output
      let tools = data.tool_return_values;
      console.log('tools:', tools, 'message:', message, 'threadId:', threadId)
      tools.forEach(tool => {
          console.log('tool:', tool, message)
          // Convert the tool output to HMTL
          displayToolOutput(tool, message);
      });
      // return the message
      return message;
    }
  }

document.getElementById('askBakeBot').addEventListener('click', function() {
  let userMessage = "I'd love a good recipe for a chicken noodle soup dish!."
  let chefType = "pro_chef"
  let servingSize = "Family-Size"
  let message_content =  + " " + userMessage + "Serving Size: " + servingSize + " "
  console.log(JSON.stringify({
          "message_content": message_content,
          "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
          "serving_size": servingSize
      }));
  // Send this data to FastAPI backend
  fetch('http://localhost:8000/create_thread_run', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        "message_content": message_content,
          "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
          "serving_size": servingSize
      })
  }
  ).then(response => response.json())
  .then(data => {
    // Convert the JSON response to a JavaScript object
    data = JSON.parse(data);
    // Extract the message from the response
    let message = data.message
    // Store the thread ID
    threadId = data.thread_id;

    // Handle each tool's output
    // We do not need to pass the tool if 
    // the tool name is "create_recipe"
    let tools = data.tool_return_values;
    console.log('tools:', tools)
    tools.forEach(tool => {
        console.log('tool:', tool)
        // Convert the tool output to HMTL
        displayToolOutput(tool, message);
    });
      let html = converter.makeHtml(message);
      document.getElementById('recipeContent').innerHTML = html;
      console.log(html);
      }).catch(error => console.error('Error:', error))
    });

  document.getElementById('uploadButton').addEventListener('click', function() {
      let fileInput = document.getElementById('recipeFile');
      let formData = new FormData();
      let sessionId = '12345'
      formData.append('file', fileInput.files[0]);

      fetch('http://localhost:8000/upload-files', {
          method: 'POST',
          body: formData,
          headers: {
              'session-id': sessionId
          }

      })
      .then(response => response.json())
      .then(data => {
          // Handle response
          console.log(data);
      })
      .catch(error => console.error('Error:', error));
  });
</script>
</html>
  