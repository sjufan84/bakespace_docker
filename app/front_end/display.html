<!DOCTYPE html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" type = "text/css" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <title id="title">BakeBot</title>
    <style>
      .small-image {
        width: 30px; /* Adjust this value to your liking */
        height: 30px; /* Adjust this value to your liking */
      }
      .user-bubble {
        background-color: #7CBCA6; /* Custom green color */
        color: white;
      }
      .flex-auto {
        flex: 1 1 auto;
      }
      .scrollable-content {
        overflow-y: auto;
        max-height: calc(100vh - 250px); /* Adjust this value as needed */
      }
      .equal-height {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
    </style>
  
</head>
  <body>
    <div id="mainContainer" class="container-fluid d-flex h-100 flex-column">
      <div class="row flex-grow-1">
        <!-- Recipe and Output Display Column -->
        <div class="col-md-8 d-flex flex-column">
          <div id="recipeContent" class="recipe-container bg-light shadow rounded p-4 scrollable-content">
            <!-- Recipe content goes here -->
          </div>
          <div id="toolOutputs" class="output-container bg-light shadow rounded p-4 scrollable-content mt-4">
            <!-- Outputs display goes here -->
          </div>
        </div>
        <div class="col-md-4 d-flex flex-column" id="chatColumn">
          <div id="chatBox" class="card p-3 bg-light shadow rounded flex-grow-1 d-flex flex-column">
            <div id="chat-messages" class="scrollable-content">
                <!-- BakeBot message -->
                <div class="bot-message mb-2 d-flex justify-content-start align-items-center mr-2" id="bot-message">
                  <img src="../../resources/bakebot_icon.png" alt="BakeBot" class="chat-icon small-image">
                  <div class="chat-bubble bot-bubble ml-2 bg-red-200">This looks great!  Let me know if you have any questions, want to generate a pairing, or anything else I can help with!
                  </div>
                </div>
                <!-- User message -->
                <div class="user-message mb-2 d-flex justify-content-end align-items-center" id="user-message">
                  <img src="../../resources/user_image.png" alt="User" class="chat-icon small-image ml-2">
                  <div class="chat-bubble user-bubble mr-3 text-end">I hate you!</div>
                </div>
              </div>
              <!-- User input area -->
              <div class="input-area mt-auto">
                <div class="row mb-2 p-2 align-bottom">
                  <textarea class="form-control" placeholder="Type your message..." id="chatInput"></textarea>
                </div>
                <div class="row col-md-12 justify-content-around mb-3">
                  <select class="col-md-6" id="chefStyle">
                  <option>Classic Pro Chef</option>
                  <option>Sweet Home Chef</option>
                  <option>Snarky Fun Chef</option>
                  </select>
                  <button class="btn btn-secondary col-md-5" id="sendChat">Send
                    <div class="spinner-border text-light" role="status" id="spinner" style="display: none;">
                      <span class="sr-only">BakeBot is thinking...</span>
                    </div>
                  </button>
                </div>
                <div class="col-md-12 justify-content-around">
                  <p class="p-2 col-md-12 font-bold">Some examples of where we can go from here:</p>
                  <button id="generatePairings" type="promptInput" class="btn border-black col-md-5 col-md-12 mb-1">Can I get a pairing with this?</button>
                  <button id="generateImage" type="promptInput" class="btn border-black col-md-12 mb-1">I'd love to create an image of this recipe.</button>
                  <button id="adjustRecipe" type="promptInput" class="btn border-black col-md-12 mb-1">I'd like to adjust this recipe.</button>
                  <button id="saveRecipe" type="promptInput" class="btn border-black col-md-12">I'd like to save this recipe.</button>   
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
<script>
  let threadId = null;
  let toolName = null;
  let toolOutput = null;
  let message = null;
  let recipeName = null;
  let recipeData = null;
  let uploadedRecipeData = null;
  let recipeContent = null;
  let recipeDetails = null;
  let converter = new showdown.Converter();
  let tools_list = ["create_recipe", "adjust_recipe", "generate_pairings", 
  "generate_image", "format_recipe", "initial_pass", "get_thread_tool_outputs",
  "get_specific_thread_tool_outputs"]
  let metadata = null;
  // Create a function to display the tool output
  const displayToolOutput = (tool, toolOutput, message) => {
    console.log('displayToolOutput called with tool:', tool, 'and message:', message, 'and toolOutput:', toolOutput)
    let toolName = tool.tool_name;
    // Get the tool name and output
   // If the tool name is generate_pairings, generate_image,
   // or adjust_recipe, display the message as HTML in the toolOutputs div
    if (toolName === 'generate_pairings' || toolName === 'generate_image') {
      // Convert the tool output to HTML
      console.log('toolOutput:', toolOutput)
      let html = converter.makeHtml(toolOutput);
      // Display the tool output in the toolOutputs div
      document.getElementById('toolOutputs').innerHTML = html;
  }
  // If the tool output is adjust_recipe, replaace the recipeContent div's innerHTML
  // with the new recipe content
  else if (toolName === 'adjust_recipe') {
    // Convert the tool output to HTML
    let html = converter.makeHtml(toolOutput);
    // Display the tool output in the recipeContent div
    document.getElementById('recipeContent').innerHTML = html;
  }
  // If the create recipe tool is called, replace the recipeContent div's innerHTML
  else if (toolName === 'create_recipe') {
    // Convert the tool output to HTML
    let html = converter.makeHtml(toolOutput);
    // Display the tool output in the recipeContent div
    document.getElementById('recipeContent').innerHTML = html;
  }
}

  
  // Create a function to load in the local recipeData and then display the results in the 
  // recipeContent div's innerHTML
  function loadRecipeData() {
    let recipeType = localStorage.getItem('recipeType');
    console.log('loadRecipeData called')
    // Get the recipe data from the local storage
    recipeData = localStorage.getItem('recipeData');
    console.log('recipeData:', recipeData)
    // Check to see if the recipeType is "uploaded" or "new"
    if (recipeType === 'uploaded') {
      console.log('recipeData.recipe_type is uploaded')
      // Display the editable fields
      displayAndEditRecipe(recipeData);
    }
    else {
      // Parse the recipe data
      recipeData = JSON.parse(recipeData);
      console.log('recipeData:', recipeData)
      recipeDetails = JSON.parse(recipeData.tool_return_values[0].output);
      console.log('recipeDetails:', recipeDetails)
      // Store the recipe name
      recipeName = recipeDetails.recipe_name;
      // Store the recipe message
      message = recipeData.message;
      // Store the thread ID
      threadId = recipeData.thread_id;
      console.log('threadId:', threadId)
      // Display the recipe
      displayRecipe(message, recipeName);
    }
  }
  // Run the loadRecipeData function if the recipeData is null
  if (recipeData === null) {
    loadRecipeData();
  }
  function displayAndEditRecipe(uploadedRecipe) {}
  
  function displayRecipe(recipeText) {
    console.log('displayRecipe called')
    // Convert the recipe text to HTML
    let html = converter.makeHtml(recipeText);
    // Display the recipe text in the recipeContent div
    document.getElementById('recipeContent').innerHTML = html;
  }
// Create a function to submit the recipeger
function submitRecipe(recipe) {}
  // Pass the recipe object to the backend for 
  // question answering, recipe adjustments, etc.
  // Present the recipe back to the user in the recipe
  // message format and the provide the options to save,
  // etc.
  
function saveRecipe(recipe) {
  // Save the recipe to the database
  // You'll need to replace this with your own function for saving the recipe
  // we coould also give this as a tool for the AI agent to use
  // @TODO: get token to test out database saves
  saveRecipeToDatabase(recipe);
}

  function convertChefStyle(chefStyle) {
      const chefStyleMap = {
        'Classic Pro Chef': 'pro_chef',
        'Sweet Home Chef': 'home_cook',
        'Snarky Fun Chef': 'adventurous_chef'
      };
      return chefStyleMap[chefStyle] || chefStyle; // Fallback to original if not found
    }

  function displayMessage(message, sender) {
    // Display the message in the appropriate chat bubble
    if (sender === 'user') {
      // Create a new user message
      let userMessage = document.createElement('div');
      userMessage.className = 'user-message mb-2 d-flex justify-content-end align-items-center';
      userMessage.innerHTML = `
        <img src="../../resources/user_image.png" alt="User" class="chat-icon small-image ml-2">
        <div class="chat-bubble user-bubble mr-3 text-end">${message}</div>
      `;
      // Append the user message to the chat messages container
      document.getElementById('chat-messages').appendChild(userMessage);
    }
    else {
      // Create a new bot message
      let botMessage = document.createElement('div');
      botMessage.className = 'bot-message mb-2 d-flex justify-content-start align-items-center mr-2';
      botMessage.innerHTML = `
        <img src="../../resources/bakebot_icon.png" alt="BakeBot" class="chat-icon small-image">
        <div class="chat-bubble bot-bubble ml-2 bg-red-200">${message}</div>
      `;
      // Append the bot message to the chat messages container
      document.getElementById('chat-messages').appendChild(botMessage);
    }
  }

  // Function to get the current value of the chef style dropdown
  function getChefStyle() {
    return document.getElementById('chefStyle').value;
  }
    
  // Create a listener for the generatePairings button
  document.getElementById('generatePairings').addEventListener('click', function() {
    let message = "Can I get a pairing with this?";
    let sender = "user";
    // Display the user message
    displayMessage(message, sender);
    let chefStyle = getChefStyle();
    console.log('generatePairings clicked')
    // Send the message to the backend
    fetchBakeBotResponse(message, chefStyle).then(response => {
      console.log('response:', response)
      // Display BakeBot's response
      // Check to see if the response is in markdown
      if (response.includes('**')) {
        // Convert the markdown to HTML
        let html = converter.makeHtml(response);
        // Display the HTML
        displayMessage(html, 'bakebot');
      }
      else {
        // Display the response as text
        displayMessage(response, 'bakebot');
      }
    });
  });
  document.getElementById('sendChat').addEventListener('click', function() {
    console.log('sendChat clicked')
    // Show the spinner
    document.getElementById('spinner').style.display = 'inline-block';
    // Get the chef style from the dropdown
    let chefStyle = document.getElementById('chefStyle').value;
    // Get the user input
    let userInput = document.getElementById('chatInput').value;
    console.log('userInput:', userInput)
    // Check if the user input is empty
    if (userInput.trim() !== '') {
        // Display user question
        displayMessage(userInput, 'user');

        // Send input to BakeBot API and get response
        fetchBakeBotResponse(userInput, chefStyle).then(response => {
          console.log('response:', response)
            // Display BakeBot's response
            // Check to see if the response is in markdown
            if (response.includes('**')) {
                // Convert the markdown to HTML
                let html = converter.makeHtml(response);
                // Display the HTML
                displayMessage(html, 'bakebot');
            }
            else {
                // Display the response as text
                displayMessage(response, 'bakebot');
            }
        });

        // Clear the input field
        document.getElementById('chatInput').value = '';
        // Hide the spinner
        document.getElementById('spinner').style.display = 'none';
    }
});


// -------------------------- Primary Chat Function -------------------------- //
async function fetchBakeBotResponse(userInput, chefStyle) {
    // Convert the frontend chef style to match the backend model's expected values
    let chefType;
    if (chefStyle === "Home Cook") {
        chefType = "home_cook";
    }
    else if (chefStyle === "Pro Chef") {
        chefType = "pro_chef";
    }
    else {
        chefType = "adventurous_chef";
    }
    console.log('fetchBakeBotResponse called with userInput:', userInput, 'and chefStyle:', chefStyle, 'and threadId:', threadId)
    // If thread ID is null, create a new thread
    if (threadId === null) {
      console.log('threadId is null')
      // Send this data to FastAPI backend
      fetch('http://localhost:8000/create_thread_run', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "message_content": userInput,
              "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
              // If there is no serving size, set it to an empty string
              "serving_size": ""
          })
      }
      ).then(response => response.json())
      .then(data => {
        console.log('data:', data)
        // Convert the JSON response to a JavaScript object
        data = JSON.parse(data);
        // Extract the message from the response
        let message = data.message
        // Store the thread ID
        threadId = data.thread_id;
        // Check to see if there is any tool output
        if (data.tool_return_values.length > 0) {
          // Handle each tool's output
          let tools = data.tool_return_values;
          console.log('tools:', tools)
          tools.forEach(tool => {
            console.log('tool:', tool)
            // Convert the tool output to HMTL
            displayToolOutput(tool, message);
          });
        }
        // return the message
        return message;
        }).catch(error => console.error('Error:', error))
    }
    else {
      let response = await fetch('http://localhost:8000/add_message_and_run', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              "message_content": userInput,
              "chef_type": chefType,
              "thread_id": threadId
          })
      });
      // Convert the JSON response to a JavaScript object
      let data = await response.json();
      console.log('data:', data)
      data = JSON.parse(data);
      // Extract the message from the response
      let message = data.message
      // Store the thread ID
      threadId = data.thread_id;
      // Check to see if there is any tool output
      if (data.tool_return_values.length > 0) {
        // Handle each tool's output
        let tools = data.tool_return_values;
        console.log('tools:', tools, 'message:', message, 'threadId:', threadId)
        tools.forEach(tool => {
            console.log('tool:', tool, message)
            // Convert the tool output to HMTL
            displayToolOutput(tool, message);
        });
      }
      // return the message
      return message;
  }
}
  // -------------------------- End Primary Chat Function -------------------------- //
</script>
</body>
</html>