<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" type = "text/css" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <title id="title">BakeBot</title>
    <style>
      .recipe-container {
          max-height: 600px; /* Adjust the height as needed */
          overflow-y: auto; /* Adds a scrollbar when content overflows */
      }
  
      .chat-container {
          /* If you need to adjust the chat container height to align with the recipe container */
          height: 600px; /* This should match the max-height of the recipe-container */
      }
  
      /* Style for chat messages */
      .chat-message {
          display: flex;
          margin-bottom: 15px;
      }
  
      .chat-bubble {
          margin-left: 10px;
          padding: 10px;
          border-radius: 15px;
      }
      /* Style for bot messages */
      .bot-message {
          justify-content: flex-start;
      }
      /* Style for user messages */
      .user-message {
          align-self: end;
      }

      /* Style for bot and user bubbles */
      .bot-bubble {
          background-color: #b05e5d;
          color: white;
          max-width: 75%;
      }
      .user-bubble {
          background-color: #e5e5ea;
          color: black;
          max-width: 75%;
          justify-self: end;
          align-self: flex-end;
      }
  
      /* ... other styles ... */
  </style>
  
</head>
<body>
<!-- Recipe Display Column -->
<div id = "mainContainer" class="grid grid-cols-2 gap-4 flex-auto">
  <!-- Section to display the recipe content to the left and the chat
  container to the right.  Recipe container should have a scroll bar by
  default and take up 3/4 of the width of the page, while the chat should
 take 1/4 on a big screen.  On smaller devices, chat should appear below 
the recipe display-->
<div class="row">
  <div class="col-md-8">
  <div class="recipe-container bg-light shadow rounded p-4">
      <h2 class="h3 font-weight-bold mb-3">Your Recipe</h2>
      <!-- Recipe content goes here -->
      <div id="recipeContent" class="recipe-content">
          <!-- Dynamically insert recipe content here -->
      </div>
      <!-- Place for generate pairings and image buttons -->
      <button id="generatePairings" class="btn btn-custom-green mt-3">Generate Pairings</button>
      <button id="generateImage" class="btn btn-custom-green mt-3">Generate Image</button>
      <button id="askBakeBot" class="btn btn-custom-green mt-3">Generate Recipe</button>
  </div>
</div>

<!-- Chat Column -->
<div class="col-md-4">
  <div id="chatBox" class="card h-100">
    <div class="card-body">
        <!-- Chat messages area -->
        <div class="chat-messages" style="height: 300px; overflow-y: auto;">
            <!-- BakeBot message -->
            <div class="bot-message mb-2 justify-start">
                <img src="../resources/bakebot_icon.png" alt="BakeBot" style="width: 30px; height: 30px;">
                <div class="chat-bubble bot-bubble justify-start">How can I help you today?</div>
            </div>

            <!-- User message -->
            <div class="user-message mb-2 justify-end">
                <div class="chat-bubble user-bubble justify-end">I hate you!</div>
                <img src="../resources/user_image.png" alt="User" style="width: 30px; height: 30px;">
            </div>

        <!-- More messages... -->
    </div>

     <!-- User input area -->
     <div class="input-area">
        <textarea class="form-control" placeholder="Type your message..." id="chatInput"></textarea>
        <div class="select-send-group grid grid-cols-4 gap-4 flex-col">
            <select class="form-control mr-2 columns-2" id="chefStyle">
                <option>Classic Pro Chef</option>
                <option>Sweet Home Chef</option>
                <option>Snarky Fun Chef</option>
            </select>
            <button class="btn" id="sendChat" style="background-color: #b05e5d; color: white;">Send</button>                
        </div>
    </div>
</div>
</div>
</div>
    </div>
  </div>
  
    <!-- Space for displaying pairing and image results -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="pairingsResult" class="result-section">
                <!-- Food pairings will be displayed here -->
            </div>
            <div id="imageResult" class="result-section">
                <!-- Recipe image will be displayed here -->
            </div>
        </div>
    </div>
</div>

</body>
<script type = "module">
  import showdown from 'https://cdn.skypack.dev/showdown';
  let threadId = null;
  // Import showdown library
  let converter = new showdown.Converter();

  document.getElementById('sendChat').addEventListener('click', function() {
    console.log('sendChat clicked')
    // Get the chef style from the dropdown
    let chefStyle = document.getElementById('chefStyle').value;
    // Convert the chef style to the appropriate format
    if (chefStyle === 'Classic Pro Chef') {
        chefStyle = 'pro_chef';
    } else if (chefStyle === 'Sweet Home Chef') {
        chefStyle = 'home_cook';
    } else if (chefStyle === 'Snarky Fun Chef') {
        chefStyle = 'adventurous_chef';
    }
    // Get the user input from the chat box
    var userInput = document.getElementById('chatInput').value;
    console.log(userInput)
    if (userInput.trim() !== '') {
        // Display user question
        displayMessage(userInput, 'user');

        // Send input to BakeBot API and get response
        fetchBakeBotResponse(userInput, chefStyle).then(response => {
            // Display BakeBot's response
            displayMessage(response, 'bakebot');
        });

        // Clear the input field
        document.getElementById('chatInput').value = '';
    }
});

function displayMessage(message, sender) {
    console.log('displayMessage called with message:', message, 'and sender:', sender);
    let chatBox = document.querySelector('#chatBox');
    console.log('chatBox:', chatBox);
    let messageDiv = document.createElement('div');
    messageDiv.classList.add(sender);
    messageDiv.textContent = message;
    chatBox.appendChild(messageDiv);
    console.log('messageDiv appended to chatBox:', chatBox);
}

async function fetchBakeBotResponse(userInput, chefStyle) {
    console.log('fetchBakeBotResponse called with userInput:', userInput, 'and chefStyle:', chefStyle, 'and threadId:', threadId)
    let response = await fetch('http://localhost:8000/add_message_and_run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            "message_content": userInput,
            "chef_type": chefStyle,
            "thread_id": threadId
        })
    });

    let data = await response.json();
    let message = data.message;
    return message;
}

document.getElementById('generatePairings').addEventListener('click', function() {
    // Code to request pairings from the API
    // Update the pairingsResult section with the response
});

document.getElementById('generateImage').addEventListener('click', function() {
    // Code to request an image from the API
    // Update the imageResult section with the response
});


document.getElementById('askBakeBot').addEventListener('click', function() {
  let userMessage = "I would like a recipe for chicken pot pie"
  let chefType = "pro_chef"
  let servingSize = "Potluck-Size"
  let message_content =  + " " + userMessage + "Serving Size: " + servingSize + " "
  console.log(JSON.stringify({
          "message_content": message_content,
          "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
          "serving_size": servingSize
      }));
  // Send this data to FastAPI backend
  fetch('http://localhost:8000/create_thread_run', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        "message_content": message_content,
          "chef_type": chefType, // Ensure this matches 'chef_type' in the Pydantic model
          "serving_size": servingSize
      })
  }
  ).then(response => response.json())
  .then(data => {
    // Convert the JSON response to a JavaScript object
      data = JSON.parse(data);
      // Extract the message from the response
    let message = data.message
    // Store the thread ID
    threadId = data.thread_id;
      // Handle response data
      console.log(data, message);
      // Convert the markdown to HTML
      let html = converter.makeHtml(message);
      console.log(html);
      // Display the recipe content
      document.getElementById('recipeContent').innerHTML = html;
    })
  .catch(error => console.error('Error:', error))
});

document.getElementById('uploadButton').addEventListener('click', function() {
    let fileInput = document.getElementById('recipeFile');
    let formData = new FormData();
    let sessionId = '12345'
    formData.append('file', fileInput.files[0]);

    fetch('http://localhost:8000/upload-files', {
        method: 'POST',
        body: formData,
        headers: {
            'session-id': sessionId
        }

    })
    .then(response => response.json())
    .then(data => {
        // Handle response
        console.log(data);
    })
    .catch(error => console.error('Error:', error));
});

</script>
</html>
